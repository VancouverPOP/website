---
import { GOOGLE_CALENDAR_ID } from '../consts';
import { fetchCalendarEvents } from '../lib/google-calendar';
import EventCalendarNav from './EventCalendarNav.astro';
import EventCardTemplate from './EventCardTemplate.astro';

const { events, fetchError } = await fetchCalendarEvents(
    GOOGLE_CALENDAR_ID,
    import.meta.env.CALENDAR_API_KEY
);

const now = new Date();
const buildMonth = now.getMonth();
const buildYear = now.getFullYear();
---

<div
    id="event-calendar"
    class="w-full"
    data-build-month={buildMonth}
    data-build-year={buildYear}
>
    <!-- Pre-fetched event data embedded at build time -->
    <script
        is:inline
        id="cal-event-data"
        type="application/json"
        set:html={JSON.stringify(events)}
    />

    <!-- Month Navigation Header -->
    <EventCalendarNav />

    {
        fetchError ? (
            <div class="py-12 text-center">
                <svg
                    class="w-12 h-12 mx-auto text-vp-purple/40 mb-4"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                </svg>
                <p class="font-raleway text-vp-black/60">
                    Unable to load events due to system error. Please check back later.
                </p>
            </div>
        ) : (
            <>
                <div
                    id="cal-empty"
                    class="hidden py-12 text-center"
                >
                    <svg
                        class="w-12 h-12 mx-auto text-vp-purple/40 mb-4"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                    </svg>
                    <p class="font-raleway text-vp-black/60">
                        No upcoming events this month.
                    </p>
                </div>

                <div
                    id="cal-events"
                    class="flex flex-col gap-4"
                />
            </>
        )
    }

    <!-- Event card template -->
    <EventCardTemplate />
</div>

<!-- Event detail modal (outside #event-calendar to avoid layout issues) -->
<div id="cal-overlay" class="hidden fixed inset-0 w-screen h-screen bg-black/50 z-51"></div>
<div id="cal-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-52" role="dialog" aria-modal="true" aria-label="Event details">
    <div class="bg-vp-light-pink rounded-xl p-6 md:p-8 shadow-lg w-[90vw] max-w-lg max-h-[85vh] overflow-y-auto">
        <div class="flex gap-4 mb-4">
            <div class="event-date-badge flex flex-col items-center justify-center min-w-16 md:min-w-20 rounded-lg bg-vp-dark-purple text-white py-3 px-2">
                <span id="modal-month-short" class="font-raleway text-xs font-bold tracking-wider opacity-80"></span>
                <span id="modal-day-num" class="font-raleway text-2xl md:text-3xl font-bold leading-none"></span>
                <span id="modal-day-name" class="font-raleway text-xs opacity-80"></span>
            </div>
            <div class="flex-1 min-w-0 flex flex-col justify-center">
                <h3 id="modal-title" class="font-raleway font-bold text-lg md:text-xl text-vp-black m-0"></h3>
            </div>
        </div>
        <div class="flex flex-col gap-3">
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 shrink-0 text-vp-purple" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"></path>
                </svg>
                <span id="modal-time" class="font-freight text-sm md:text-base text-vp-purple"></span>
            </div>
            <div id="modal-location-wrapper" class="flex items-start gap-2">
                <svg class="w-4 h-4 shrink-0 text-vp-black/60 mt-0.5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path>
                </svg>
                <span id="modal-location" class="font-freight text-sm md:text-base text-vp-black/60"></span>
            </div>
            <div id="modal-description-wrapper">
                <hr class="border-vp-purple/20 my-2" />
                <div id="modal-description" class="font-raleway text-sm md:text-base text-vp-black/70 leading-relaxed"></div>
            </div>
        </div>
    </div>
</div>

<script>
    import type { CalendarEvent } from '../types/calendar';
    import {
        MONTH_NAMES,
        DAY_NAMES,
        formatTime,
        formatDayDate,
        isAllDay,
        getEventStartDate,
        getEventEndDate,
        getEventMonth,
        filterEventsByMonth,
        renderLocation,
        renderFullLocation,
    } from '../scripts/calendar-utils';

    // --- Modal elements ---
    const calOverlay = document.getElementById('cal-overlay');
    const calModal = document.getElementById('cal-modal');

    function openEventModal(event: CalendarEvent) {
        if (!calModal || !calOverlay) return;

        const startStr = getEventStartDate(event);
        const endStr = getEventEndDate(event);
        const { dayName, dayNum, monthShort } = formatDayDate(startStr);

        // Populate date badge
        const monthShortEl = document.getElementById('modal-month-short');
        const dayNumEl = document.getElementById('modal-day-num');
        const dayNameEl = document.getElementById('modal-day-name');
        if (monthShortEl) monthShortEl.textContent = monthShort;
        if (dayNumEl) dayNumEl.textContent = String(dayNum);
        if (dayNameEl) dayNameEl.textContent = dayName.slice(0, 3);

        // Title
        const titleEl = document.getElementById('modal-title');
        if (titleEl) titleEl.textContent = event.summary || 'Untitled Event';

        // Time -- include full date for context
        const timeEl = document.getElementById('modal-time');
        if (timeEl) {
            const startDate = new Date(startStr);
            const dateLabel = `${DAY_NAMES[startDate.getDay()]}, ${MONTH_NAMES[startDate.getMonth()]} ${startDate.getDate()}, ${startDate.getFullYear()}`;
            if (isAllDay(event)) {
                timeEl.textContent = `${dateLabel} \u2022 All Day`;
            } else {
                timeEl.textContent = `${dateLabel} \u2022 ${formatTime(startStr)} - ${formatTime(endStr)}`;
            }
        }

        // Location (full, not shortened)
        renderFullLocation(
            document.getElementById('modal-location-wrapper') as HTMLElement,
            document.getElementById('modal-location') as HTMLElement,
            event.location || ''
        );

        // Description (rendered as HTML)
        const descWrapper = document.getElementById(
            'modal-description-wrapper'
        );
        const descEl = document.getElementById('modal-description');
        const rawDescription = event.description || '';
        if (descEl && descWrapper) {
            if (rawDescription.trim()) {
                descWrapper.classList.remove('hidden');
                descEl.innerHTML = rawDescription;

                // Style dynamically injected links from calendar description
                descEl.querySelectorAll('a').forEach((a) => {
                    a.classList.add(
                        'text-vp-purple',
                        'underline',
                        'hover:opacity-80'
                    );
                });
            } else {
                descWrapper.classList.add('hidden');
            }
        }

        // Show modal and overlay
        calOverlay.classList.remove('hidden');
        calOverlay.classList.add('flex');
        calModal.classList.remove('hidden');
        calModal.classList.add('flex');

        // Prevent background scroll, compensating for scrollbar width to avoid layout shift
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = `${scrollbarWidth}px`;

        // Focus the modal for accessibility
        calModal.focus();
    }

    function closeEventModal() {
        if (!calModal || !calOverlay) return;
        calOverlay.classList.add('hidden');
        calOverlay.classList.remove('flex');
        calModal.classList.add('hidden');
        calModal.classList.remove('flex');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Dismiss on overlay click
    calOverlay?.addEventListener('click', closeEventModal);

    // Dismiss on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeEventModal();
    });

    // --- Calendar card rendering ---

    function renderEvent(
        event: CalendarEvent,
        eventIndex: number
    ): HTMLElement {
        const template = document.getElementById(
            'cal-event-template'
        ) as HTMLTemplateElement;
        const card = template.content
            .firstElementChild!.cloneNode(true) as HTMLElement;

        // Store the event index so the click handler can look up the event
        card.dataset.eventIndex = String(eventIndex);

        const startStr = getEventStartDate(event);
        const endStr = getEventEndDate(event);
        const { dayName, dayNum, monthShort } = formatDayDate(startStr);

        // Date badge
        card.querySelector('[data-field="month-short"]')!.textContent =
            monthShort;
        card.querySelector('[data-field="day-num"]')!.textContent =
            String(dayNum);
        card.querySelector('[data-field="day-name"]')!.textContent =
            dayName.slice(0, 3);

        // Title
        card.querySelector('[data-field="title"]')!.textContent =
            event.summary || 'Untitled Event';

        // Time
        const timeDisplay = isAllDay(event)
            ? 'All Day'
            : `${formatTime(startStr)} - ${formatTime(endStr)}`;
        card.querySelector('[data-field="time"]')!.textContent = timeDisplay;

        // Location
        renderLocation(
            card.querySelector('[data-field="location-wrapper"]') as HTMLElement,
            card.querySelector('[data-field="location"]') as HTMLElement,
            event.location || ''
        );

        const descEl = card.querySelector(
            '[data-field="description"]'
        ) as HTMLElement;
        const rawDescription = event.description || '';

        // Remove HTML tags and trim whitespace from description
        const plainDescription = rawDescription
            .replace(/<[^>]*>/g, '')
            .trim();
        if (plainDescription) {
            descEl.textContent =
                plainDescription.length > 200
                    ? plainDescription.slice(0, 200) + '...'
                    : plainDescription;
        } else {
            descEl.classList.add('hidden');
        }

        return card;
    }

    function initCalendar() {
        const container = document.getElementById('event-calendar');
        if (!container) return;

        // Read pre-fetched event data from the embedded JSON script tag
        const dataScript = document.getElementById('cal-event-data');
        if (!dataScript) return;

        let allEvents: CalendarEvent[];
        try {
            allEvents = JSON.parse(dataScript.textContent || '[]');
        } catch {
            return;
        }

        const monthLabelEl = document.getElementById('cal-month-label');
        const prevBtnEl = document.getElementById('cal-prev') as HTMLButtonElement | null;
        const nextBtnEl = document.getElementById('cal-next') as HTMLButtonElement | null;
        const emptyEl = document.getElementById('cal-empty');
        const eventsListEl = document.getElementById('cal-events');

        if (!monthLabelEl || !prevBtnEl || !nextBtnEl || !emptyEl || !eventsListEl)
            return;

        const monthLabel: HTMLElement = monthLabelEl;
        const prevBtn: HTMLButtonElement = prevBtnEl;
        const nextBtn: HTMLButtonElement = nextBtnEl;
        const empty: HTMLElement = emptyEl;
        const eventsList: HTMLElement = eventsListEl;

        // Use build-time month as the baseline (data-build-month, data-build-year)
        const buildMonth = parseInt(
            container.dataset.buildMonth || String(new Date().getMonth()),
            10
        );
        const buildYear = parseInt(
            container.dataset.buildYear || String(new Date().getFullYear()),
            10
        );

        let currentYear = buildYear;
        let currentMonth = buildMonth;

        // Determine the furthest month with data for limiting navigation
        let maxYear = buildYear;
        let maxMonth = buildMonth;
        for (const event of allEvents) {
            const { year, month } = getEventMonth(event);
            if (year > maxYear || (year === maxYear && month > maxMonth)) {
                maxYear = year;
                maxMonth = month;
            }
        }

        function renderMonth(year: number, month: number) {
            const monthEvents = filterEventsByMonth(allEvents, year, month);

            if (monthEvents.length === 0) {
                empty.classList.remove('hidden');
                eventsList.classList.add('hidden');
            } else {
                empty.classList.add('hidden');
                eventsList.classList.remove('hidden');
                eventsList.replaceChildren(
                    ...monthEvents.map((event, index) =>
                        renderEvent(event, index)
                    )
                );
            }

            // Store the current month's events for modal lookups
            currentMonthEvents = monthEvents;
        }

        // Track current month's filtered events for modal access
        let currentMonthEvents: CalendarEvent[] = [];

        // Event delegation: open modal when date badge or title is clicked
        eventsList.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;

            // Check if click is on the date badge trigger or title
            const trigger =
                target.closest('[data-field="date-trigger"]') ||
                target.closest('[data-field="title"]');
            if (!trigger) return;

            const card = target.closest('[data-event-index]') as HTMLElement | null;
            if (!card) return;

            const index = parseInt(card.dataset.eventIndex || '', 10);
            if (Number.isNaN(index) || !currentMonthEvents[index]) return;

            openEventModal(currentMonthEvents[index]);
        });

        // Also handle keyboard activation (Enter/Space) on triggers
        eventsList.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter' && e.key !== ' ') return;

            const target = e.target as HTMLElement;
            const trigger =
                target.closest('[data-field="date-trigger"]') ||
                target.closest('[data-field="title"]');
            if (!trigger) return;

            e.preventDefault();
            const card = target.closest('[data-event-index]') as HTMLElement | null;
            if (!card) return;

            const index = parseInt(card.dataset.eventIndex || '', 10);
            if (Number.isNaN(index) || !currentMonthEvents[index]) return;

            openEventModal(currentMonthEvents[index]);
        });

        function updateMonth(year: number, month: number) {
            currentYear = year;
            currentMonth = month;
            monthLabel.textContent = `${MONTH_NAMES[month]} ${year}`;

            // Disable prev button if viewing the build month (earliest with data)
            const isFirstMonth =
                year === buildYear && month === buildMonth;
            prevBtn.disabled = isFirstMonth;
            prevBtn.classList.toggle('opacity-40', isFirstMonth);
            prevBtn.classList.toggle('cursor-not-allowed', isFirstMonth);

            // Disable next button if viewing the last month with data
            const isLastMonth =
                year === maxYear && month === maxMonth;
            nextBtn.disabled = isLastMonth;
            nextBtn.classList.toggle('opacity-40', isLastMonth);
            nextBtn.classList.toggle('cursor-not-allowed', isLastMonth);

            renderMonth(year, month);
        }

        prevBtn.addEventListener('click', () => {
            if (prevBtn.disabled) return;
            let newMonth = currentMonth - 1;
            let newYear = currentYear;
            if (newMonth < 0) {
                newMonth = 11;
                newYear--;
            }
            updateMonth(newYear, newMonth);
        });

        nextBtn.addEventListener('click', () => {
            if (nextBtn.disabled) return;
            let newMonth = currentMonth + 1;
            let newYear = currentYear;
            if (newMonth > 11) {
                newMonth = 0;
                newYear++;
            }
            updateMonth(newYear, newMonth);
        });

        // Initialize with the build month
        updateMonth(currentYear, currentMonth);
    }

    // Run initialization after DOM is ready
    // NOTE: this uses DOMContentLoaded instead of astro:page-load,
    // because we don't use View Transitions
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCalendar);
    } else {
        initCalendar();
    }
</script>
